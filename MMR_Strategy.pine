//@version=5
indicator("200 SMA with Above Count and Delta", overlay=true)

// Calculate 200 SMA
sma200 = ta.sma(close, 200)

// Plot the SMA lines
plot(sma200, color=color.rgb(211, 211, 211), linewidth=2, title="200 SMA")
// plot(sma200*1.05, color=color.green, linewidth=2, title="200 SMA × 1.05")
plot(sma200*1.09, color=color.red, linewidth=2, title="200 SMA × 1.09")
plot(sma200*0.95, color=color.red, linewidth=2, title="200 SMA × 0.95")

// Calculate aboveCount for the last 31 days (including current day)
// This matches your TypeScript logic: slice(Math.max(0, yesterdayIndex - 30), yesterdayIndex + 1)
aboveCount = 0
windowLength = 30

for i = 0 to windowLength - 1
    if bar_index >= i
        pastClose = close[i]
        pastSma = sma200[i]
        if not na(pastSma) and pastClose >= pastSma * 1.09
            aboveCount += 1

// Calculate percentage
abovePercentage = windowLength > 0 ? aboveCount / windowLength * 100 : 0

// Calculate delta - sum of absolute daily rates over last 21 days
// This matches your TypeScript logic: slice(Math.max(0, yesterdayIndex - 20), yesterdayIndex + 1)
// Note: Using daily percentage change as proxy for the 'rate' field from your QQQ data
deltaSum = 0.0
deltaWindowLength = 21

for i = 0 to deltaWindowLength - 1
    if bar_index >= i + 1  // Need at least 1 bar of history for rate calculation
        currentClose = close[i]
        previousClose = close[i + 1]
        if not na(currentClose) and not na(previousClose) and previousClose != 0
            dailyRate = (currentClose - previousClose) / previousClose * 100
            deltaSum += math.abs(dailyRate)

// Check if market is stable (delta < 35)
isStable = deltaSum < 35

// Display the information in a table
var table infoTable = table.new(position.bottom_right, 2, 7, bgcolor=color.white, border_width=1)

if barstate.islast
    table.cell(infoTable, 0, 0, "Above 109% Count:", text_color=color.black, bgcolor=color.rgb(211, 211, 211))
    table.cell(infoTable, 1, 0, str.tostring(aboveCount), text_color=color.black)
    
    table.cell(infoTable, 0, 1, "Window Length:", text_color=color.black, bgcolor=color.rgb(211, 211, 211))
    table.cell(infoTable, 1, 1, str.tostring(windowLength), text_color=color.black)
    
    table.cell(infoTable, 0, 2, "Percentage:", text_color=color.black, bgcolor=color.rgb(211, 211, 211))
    table.cell(infoTable, 1, 2, str.tostring(abovePercentage, "#.##") + "%", text_color=color.black)
    
    table.cell(infoTable, 0, 3, "Above 75%:", text_color=color.black, bgcolor=color.rgb(211, 211, 211))
    table.cell(infoTable, 1, 3, abovePercentage >= 75 ? "grow too fast" : "not too fast, safe", 
              text_color= color.black)
    
    table.cell(infoTable, 0, 4, "Current Delta:", text_color=color.black, bgcolor=color.rgb(211, 211, 211))
    table.cell(infoTable, 1, 4, str.tostring(deltaSum, "#.## (< 35?)"), text_color=color.black)

// Optional: Plot the delta as a line in a separate pane
// Uncomment the next line if you want to see the delta trend
// plot(deltaSum, title="Current Delta", color=color.orange, display=display.data_window)

// === Vertical line at last 30 bars ===
if barstate.islast and bar_index >= 30
    line.new(bar_index - 30, low, bar_index - 30, high, xloc = xloc.bar_index, extend = extend.both, color = color.orange, width = 2, style = line.style_dashed )